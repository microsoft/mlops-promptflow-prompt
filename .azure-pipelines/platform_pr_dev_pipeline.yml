
parameters:
 - name: exec_environment
   displayName: "Execution Environment"
   default: "pr"
 - name: model_type
   displayName: "type of model to execute"


stages:
  # Code Validation Stage
  - stage: build_validation
    displayName: 'Validate Code and Evaluate PF Flow'
    jobs:
    - template: build_validation_pipeline.yml

  # Execute and evaluate PF flow stage
  - stage: execute_evaluation_stage
    displayName: 'Execute Evaluation Stage'
    dependsOn: 
    - build_validation
    jobs:
    - job: Execute_pf_Pipeline
      displayName: 'Execute Evaluation'
      steps:
      - template: templates/configure_azureml_agent.yml
      - script: |
          python -m mlops.connections.local_create_aoai_connection \
            --aoai-connection-name "aoai"
        env:
          AOAI_API_KEY: $(AOAI_API_KEY)
        displayName: 'Create a Open AI conection on DevOps host'

      - script: |
            python -m mlops.local_prompt_pipeline \
              --config_name ${{ parameters.model_type }} \
              --environment_name ${{ parameters.exec_environment }} \
              --output_file run_id.txt
        displayName: 'Execute a PF Flow to generate run id'

      - script: |
            readarray arr <"run_id.txt"
            run_name=${arr[0]}
            echo $run_name
            echo "##vso[task.setvariable variable=RUN_NAME;isOutput=true;]$run_name"
        name: read_run_id
        displayName: 'Get run_id for evaluation'

      - script: |
            python -m mlops.local_prompt_eval \
              --config_name ${{ parameters.model_type }} \
              --environment_name ${{ parameters.exec_environment }} \
              --run_id "$(read_run_id.RUN_NAME)"
        displayName: 'Run Evaluation'
