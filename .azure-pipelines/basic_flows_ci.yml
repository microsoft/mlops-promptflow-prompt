pr: none
trigger:
  branches:
   include:
     - development
  paths:
    include:
      - .azure-pipelines/basic_flows_ci.yml
      - flows/function_basic_flow/*
      - flows/class_basic_flow/*
      - flows/yaml_basic_flow/*
      - src/basic_func_impl/*

pool:
  vmImage: ubuntu-latest


variables:
- group: mlops_platform_dev_vg


stages:
  - stage: evaluation
    displayName: 'Evaluate Basic PF Flow'
    jobs:
    - job: Execute_pf_Pipeline
      displayName: 'Execute Evaluation'
      steps:
      - template: templates/configure_devops_agent.yml

      - task: AzureCLI@2
        displayName: 'Run Evaluation for Function Flow'
        continueOnError: false
        env:
          SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
          AOAI_BASE_ENDPOINT: $(AOAI_BASE_ENDPOINT)
          AOAI_API_KEY: $(AOAI_API_KEY)
        inputs: 
          azureSubscription: $(AZURE_RM_SVC_CONNECTION)
          scriptType: bash
          workingDirectory: $(System.DefaultWorkingDirectory)
          scriptLocation: inlineScript
          inlineScript: |
            python -m flows.function_basic_flow.evaluate.evaluate \
              --environment_name dev

      - task: AzureCLI@2
        displayName: 'Run Evaluation for Class Flow'
        continueOnError: false
        env:
          SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
          AOAI_BASE_ENDPOINT: $(AOAI_BASE_ENDPOINT)
          AOAI_API_KEY: $(AOAI_API_KEY)
        inputs: 
          azureSubscription: $(AZURE_RM_SVC_CONNECTION)
          scriptType: bash
          workingDirectory: $(System.DefaultWorkingDirectory)
          scriptLocation: inlineScript
          inlineScript: |
            python -m flows.class_basic_flow.evaluate.evaluate \
              --environment_name dev

      - task: AzureCLI@2
        displayName: 'Run Evaluation for YAML Flow'
        continueOnError: false
        env:
          SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
          AOAI_BASE_ENDPOINT: $(AOAI_BASE_ENDPOINT)
          AOAI_API_KEY: $(AOAI_API_KEY)
        inputs: 
          azureSubscription: $(AZURE_RM_SVC_CONNECTION)
          scriptType: bash
          workingDirectory: $(System.DefaultWorkingDirectory)
          scriptLocation: inlineScript
          inlineScript: |
            python -m flows.yaml_basic_flow.evaluate.evaluate \
              --environment_name dev

  - stage: deploy_prompts
    dependsOn: evaluation
    displayName: Deploy Promptflow Basic Flows as Azure Functions
    jobs:
    - job: deploy_flow
      steps:
      - template: templates/configure_devops_agent.yml

      - task: CopyFiles@2
        displayName: Prepare Function Flow to Deploy
        inputs:
          SourceFolder: '$(System.DefaultWorkingDirectory)/flows/function_basic_flow/standard'
          Contents: '**'
          TargetFolder: '$(System.DefaultWorkingDirectory)/src/basic_func_impl/function_basic_invoke_code'

      - task: CopyFiles@2
        displayName: Prepare Class Flow to Deploy
        inputs:
          SourceFolder: '$(System.DefaultWorkingDirectory)/flows/class_basic_flow/standard'
          Contents: '**'
          TargetFolder: '$(System.DefaultWorkingDirectory)/src/basic_func_impl/class_basic_invoke_code'

      - task: CopyFiles@2
        displayName: Prepare YAML Flow to Deploy
        inputs:
          SourceFolder: '$(System.DefaultWorkingDirectory)/flows/yaml_basic_flow/standard'
          Contents: '**'
          TargetFolder: '$(System.DefaultWorkingDirectory)/src/basic_func_impl/yaml_basic_invoke_code'

      - task: ArchiveFiles@2
        displayName: "Archive files"
        inputs:
          rootFolderOrFile: "$(System.DefaultWorkingDirectory)/src/basic_func_impl"
          includeRootFolder: false
          archiveFile: "$(System.DefaultWorkingDirectory)/build$(Build.BuildId).zip"

      - task: AzureCLI@2
        name: deploy_function
        displayName: Deploy Azure Function
        continueOnError: false
        env:
          AOAI_API_KEY: $(AOAI_API_KEY)
          AOAI_BASE_ENDPOINT: $(AOAI_BASE_ENDPOINT)
        inputs: 
          azureSubscription: $(AZURE_RM_SVC_CONNECTION)
          scriptType: bash
          workingDirectory: $(System.DefaultWorkingDirectory)
          scriptLocation: inlineScript
          inlineScript: |
            az functionapp deployment source config-zip -g $(RESOURCE_GROUP_NAME) -n \
            $(APP_NAME) --src '$(System.DefaultWorkingDirectory)/build$(Build.BuildId).zip' \
            --build-remote true

            az functionapp config appsettings set --name $(APP_NAME) --resource-group $(RESOURCE_GROUP_NAME) \
            --settings "AZURE_OPENAI_DEPLOYMENT=gpt-35-turbo" \
            "AZURE_OPENAI_API_VERSION=2023-07-01-preview" \
            "AZURE_OPENAI_API_KEY=$(AOAI_API_KEY)" \
            "AZURE_OPENAI_ENDPOINT=$(AOAI_BASE_ENDPOINT)"

      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(System.DefaultWorkingDirectory)/build$(Build.BuildId).zip'
          artifactName: 'drop'
